<html>
<meta charset="UTF-8">
<head>
	<link rel="stylesheet" href="css/bootstrap.min.css">
</head>
<body>
<div class="form-group">
  <label  for="natureOfDuty">Nature of Duty</label>
  <input type="text" id="natureOfDuty" name="natureOfDuty"/>
</div>

<div class="form-group">
  <label  for="">Organization</label>
  <input type="text" id="organization" name="organization"/>
</div>

<div class="form-group">
  <label  for="">From (Date)</label>
  <input type="text" id="fromDate" name="fromDate"/>
</div>

<div class="form-group">
  <label  for="">To (Date)</label>
  <input type="text" id="toDate" name="toDate"/>
</div>

<div class="form-group">
  <label for="da6csv">Choose the DA6 CSV file to upload</label>
  <input type="file" id="da6csv" name="da6csv"/>
</div>
<hr>
<div id="da6" class="da6">
  <table id="da6_table" class="table">
  </table>
</div>


<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script>

var DateTime = luxon.DateTime
var da6_pers_list = []

// on a change, populate the da6
$('#da6csv').on('change', function(event) {
  var da6_file = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var da6group = $.csv.toObjects(e.target.result)
    // add the entries in the personnelGroup to the personnel chooser
    $.each(da6group, function (index, person) {
      // add all entries to the da6_pers_list
			// only add rows with people in them
			if (person.Person !== '') {
				da6_pers_list.push(person)
			}
    })
    // sort the list, first sort by rank, then sort by lastname
    da6_pers_list = sort_list(da6_pers_list)
		for (var i = 0; i < da6_pers_list.length; i++) {
			populateDutyDays(da6_pers_list, i)
		}
		assignDuty(da6_pers_list, 0)
    generateDa6Table(da6_pers_list)
  }
  reader.readAsText(da6_file)
})

// this takes the input da6 list and sorts according to rank then name
function sort_list (sort_file) {
  // sort the pers list
  var ordering = {} // map for efficient lookup of sortIndex
  var sortOrder = ['MSG', 'SFC', 'SSG', 'SGT', 'CPL', 'SPC', 'PFC']
  for (var i = 0; i < sortOrder.length; i++) {
    ordering[sortOrder[i]] = i
  }
  sort_file.sort( function(a, b) {
    return (ordering[a.Rank] - ordering[b.Rank]) || a.Person.localeCompare(b.Person)
  })
  return sort_file
}

function populateDutyDays (da6_pers_list, rowNum) {
  // check if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day
	var daysSinceLast = da6_pers_list[rowNum]['Days Since Last']
	if (!isNaN(parseInt(daysSinceLast))) {
		daysSinceLast = parseInt(daysSinceLast)
	} else if (parseInt(daysSinceLast.substring(1)) > 0) {
		daysSinceLast = parseInt(daysSinceLast.substring(1))
	} else {
		daysSinceLast = 0
	}
	da6_pers_list[rowNum]['Duty'] = []
  for (var i = 0; i < 40; i++) {
		da6_pers_list[rowNum]['Duty'].push(daysSinceLast++)
  }
}

function adjustRowAvailability (da6_pers_list, rowNum) {
  // see if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day
  try {
		var dayVal =  parseInt(da6_pers_list[rowNum]["Days Since Last"])
	}
	catch (err) {
		dayVal = 0
	}
	// 'A' - don't increment days since duty
	// 'U' or 'D' - do increment the days since duty
  for (var i = 0; i < 40; i++) {
    if (da6_pers_list[rowNum]['Duty'][i] == 'A') { 
      continue
		} else if (isNaN(da6_pers_list[rowNum]['Duty'][i])) { 
			dayVal++
    } else {
      da6_pers_list[rowNum]['Duty'][i] = dayVal++
    }
  }
}


function assignDuty (da6_list, column) {
  for(var col = column; col < 40; col++) {
    // assemble an array of the duty
    var soldierDuty = []
    for (var i = 0; i < da6_list.length; i++) {
      var dutyDays = parseInt(da6_list[i]['Duty'][col])
      if (isNaN(dutyDays)) { 
        dutyDays = 0 
      }
      soldierDuty.push(dutyDays)
    }
    // now assign a duty to the Soldier with the highest days
    var highestDays = Math.max(...soldierDuty)
    var soldierIndex = soldierDuty.indexOf(highestDays)
    // now reset the days to '0'

    // don't overwrite 'A' 'U' or 'D'
		// 'A' - don't increment days since duty
		// 'U' or 'D' - do increment the days since duty
    var dayValue = 0
    for (var j = col; j < 40; j++) {
			// check to see if the value is not a number
		  if (da6_list[soldierIndex]['Duty'][j] == 'A') {
        continue
			} else if (isNaN(parseInt(da6_list[soldierIndex]['Duty'][j]))) {
				dayValue++
			} else {
				da6_list[soldierIndex]['Duty'][j] = dayValue++
			}
    }
  }
}

// generate table
function generateDa6Table (da6_pers_list) {

  // write a header row that will have the month

  var da6_table = document.getElementById('da6_table')
	while(da6_table.hasChildNodes())
	{
		 da6_table.removeChild(da6_table.firstChild);
	}

	var natureOfDuty = $('#natureOfDuty').val()
	var organization = $('#organization').val()
	var fromDate = $('#fromDate').val()
	var toDate = $('#toDate').val()
	var fromDateVal = ''

	if (fromDate == '') {
		fromDateVal = DateTime.local()
	} else {
		fromDateVal = DateTime.fromISO(fromDate, { zone: 'utc' })
	}
  var toDateVal = fromDateVal.plus({ days: 39 })

  // draw the first header
	var first_row = da6_table.insertRow(-1)
	var duty_roster_cell = first_row.insertCell(-1)
	duty_roster_cell.innerHTML = 'DUTY ROSTER'
	duty_roster_cell.colSpan = 2
	var natureOfDutyCell = first_row.insertCell(-1)
	natureOfDutyCell.innerHTML = 'NATURE OF DUTY<br />' + natureOfDuty
	natureOfDutyCell.colSpan = 12
	var orgCell = first_row.insertCell(-1)
	orgCell.innerHTML = 'ORGANIZATION<br />' + organization
	orgCell.colSpan = 14
	var fromCell = first_row.insertCell(-1)
	fromCell.innerHTML = 'FROM (Date)<br />' + fromDateVal.toFormat('dd MMM')
	fromCell.colSpan = 8
	var toCell = first_row.insertCell(-1)
	toCell.innerHTML = 'TO (Date)<br />' + toDateVal.toFormat('dd MMM')
	toCell.colSpan = 7

	// draw the header
  var newRow = da6_table.insertRow(-1);
	var grade_cell = newRow.insertCell(-1)
	grade_cell.innerHTML = 'GRADE'
	grade_cell.rowSpan = 2
	var nameCell = newRow.insertCell(-1)
	nameCell.innerHTML = 'NAME'
	nameCell.rowSpan = 2
  var date_cell = newRow.insertCell(-1)
	date_cell.innerHTML = 'Month'

	// insert the second row for the date
	var dayCell 
	var monthNameCell
  var secondNewRow = da6_table.insertRow(-1)
	dayCell = secondNewRow.insertCell(-1)
	dayCell.innerHTML = 'Day'
	var curMonth
	var monthCellSpanWidth = 0
	var curMonthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

	var currentDay = fromDateVal
	for (var h = 0; h < 40; h++) {
    dayCell = secondNewRow.insertCell(-1)
		dayCell.innerHTML = currentDay.day
		if (h == 0) {
			monthNameCell = newRow.insertCell(-1)
		  curMonth = currentDay.month
			monthNameCell.innerHTML = curMonthIndex[parseInt(curMonth) - 1]
		}
		if (curMonth != currentDay.month) {
		  curMonth = currentDay.month
			// set the monthNameCell span and then update the month
			monthNameCell.colSpan = monthCellSpanWidth
			monthNameCell = newRow.insertCell(-1)
			monthCellSpanWidth = 0
			monthNameCell.innerHTML = curMonthIndex[parseInt(curMonth) - 1]
		}
		if (h == 39) {
			// this is the last time through, set the final month spanwidth
			monthCellSpanWidth++
			monthNameCell.colSpan = monthCellSpanWidth
		}
    currentDay = currentDay.plus({ days: 1 })
		monthCellSpanWidth++
	}

  for (var i = 0; i < da6_pers_list.length; i++) {
    var newRow = da6_table.insertRow(-1);
    var rank_cell = newRow.insertCell(-1)
    var nameCell = newRow.insertCell(-1)
    var newCell

    rank_cell.innerHTML = da6_pers_list[i].Rank
		nameCell.colSpan = 2
    nameCell.innerHTML = da6_pers_list[i].Person
    for (var j = 0; j < 40; j++) {
      newCell = newRow.insertCell(-1)
			if (da6_pers_list[i]['Duty'][j] == 0) {
      	newCell.innerHTML = '///'
      } else { 
				newCell.innerHTML = da6_pers_list[i]['Duty'][j]
			}
      newCell.onclick = function () {
        changeText(this)
      }
    }
  }
}

function changeText (tableCell) {

	// adjust the da6_pers_list
	var dayColumn = parseInt(tableCell.cellIndex) - 2
	var dayRow = parseInt(tableCell.parentElement.rowIndex) - 3

  if(tableCell.innerHTML == 'A') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'D'
    //tableCell.innerHTML = 'D'
  }
  else if(tableCell.innerHTML == 'D') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'U'
    //tableCell.innerHTML = 'U'
  }
  else if(tableCell.innerHTML == 'U') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 0
    //tableCell.innerHTML = 0
  }
  else {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'A'
    //tableCell.innerHTML = 'A'
  }

	for (var i = 0; i < da6_pers_list.length; i++) {
		adjustRowAvailability(da6_pers_list, i)
	}

  //assignDuty(da6_pers_list, dayColumn)
  assignDuty(da6_pers_list, 0)

  generateDa6Table(da6_pers_list)

}

// (1) Soldiers who are absent or otherwise not available because of leave, pass, special duty, temporary duty, illness in
// line of duty, or any other authorized reason (not due to misconduct) will be indicated by the letter "A." When a new DA
// Form 6 is initiated that carries over a nonchargeable status from the previous DA Form 6, a superscript number (for example, A3) will be manually added to the abbreviation "A" to indicate the last number charged, as shown on the previous DA
// Form 6, before the Soldier entered upon the nonchargeable status. Entering such a number in the first column of a new DA
// Form 6 eliminates the necessity for referring to the previous DA Form 6 when the Soldier returns to a chargeable status.
// Note. Soldier on temporary duty travel that does not extend beyond regular duty hours will not qualify for an "A" for that
// day of temporary duty.

// (2) Soldiers eligible for detail who could not be selected because of previous detail or other duty will be indicated by
// the letter "D."

// (3) Soldiers not available because of being absent without leave, in arrest, in confinement, illness not in line of duty, or
// otherwise not available as a result of their own misconduct will be indicated by the letter "U."

</script>

</body>
</html>
