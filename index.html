<html>
<meta charset="UTF-8">
<head>
	<link rel="stylesheet" href="css/bootstrap.min.css">
</head>
<body>
<div class="form-group">
  <label  for="natureOfDuty">Nature of Duty</label>
  <input type="text" id="natureOfDuty" name="natureOfDuty"/>
</div>

<div class="form-group">
  <label  for="">Organization</label>
  <input type="text" id="organization" name="organization"/>
</div>

<div class="form-group">
  <label  for="">From (Date)</label>
  <input type="text" id="fromDate" name="fromDate"/>
</div>

<div class="form-group">
  <label  for="">To (Date)</label>
  <input type="text" id="toDate" name="toDate"/>
</div>

<div class="form-group">
  <label  for="">People per duty</label>
  <input type="number" id="peoplePerDuty" name="peoplePerDuty"/>
</div>

<div class="form-group">
  <label for="da6csv">Choose the DA6 CSV file to upload</label>
  <input type="file" id="da6csv" name="da6csv"/>
</div>
<hr>
<div id="da6" class="da6">
  <table id="da6_table" class="table table-bordered">
  </table>
</div>


<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script>

var DateTime = luxon.DateTime
var da6_pers_list = []

// Update the table when changing the number of people per task
$('#peoplePerDuty').change( function () {
	for (var i = 0; i < da6_pers_list.length; i++) {
		adjustRowAvailability(da6_pers_list, i)
	}
  assignDuty(da6_pers_list, 0)
  generateDa6Table(da6_pers_list)
})

// populate the DA6 when the CSV file is loaded
$('#da6csv').on('change', function(event) {
  var da6_file = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var da6group = $.csv.toObjects(e.target.result)
    // add the entries in the personnelGroup to the personnel chooser
    $.each(da6group, function (index, person) {
      // add all entries to the da6_pers_list
			// only add rows with people in them
			if (person.Person !== '') {
				da6_pers_list.push(person)
			}
    })
    // sort the list, first sort by rank, then sort by lastname
    da6_pers_list = sort_list(da6_pers_list)
		for (var i = 0; i < da6_pers_list.length; i++) {
			populateDutyDays(da6_pers_list, i)
		}
		assignDuty(da6_pers_list, 0)
    generateDa6Table(da6_pers_list)
  }
  reader.readAsText(da6_file)
})

// this takes the input da6 list and sorts according to rank then name
function sort_list (sort_file) {
  // sort the pers list
  var ordering = {} // map for efficient lookup of sortIndex
  var sortOrder = ['MSG', 'SFC', 'SSG', 'SGT', 'CPL', 'SPC', 'PFC']
  for (var i = 0; i < sortOrder.length; i++) {
    ordering[sortOrder[i]] = i
  }
  sort_file.sort( function(a, b) {
    return (ordering[a.Rank] - ordering[b.Rank]) || a.Person.localeCompare(b.Person)
  })
  return sort_file
}

function populateDutyDays (da6_pers_list, rowNum) {
  // check if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day
	var daysSinceLast = da6_pers_list[rowNum]['Days Since Last']
	if (!isNaN(parseInt(daysSinceLast))) {
		daysSinceLast = parseInt(daysSinceLast)
	} else if (parseInt(daysSinceLast.substring(1)) > 0) {
		daysSinceLast = parseInt(daysSinceLast.substring(1))
	} else {
		daysSinceLast = 0
	}
	da6_pers_list[rowNum]['Duty'] = []
  for (var i = 0; i < 40; i++) {
		da6_pers_list[rowNum]['Duty'].push(daysSinceLast++)
  }
}

function adjustRowAvailability (da6_pers_list, rowNum) {
  // see if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day
  try {
		var dayVal =  parseInt(da6_pers_list[rowNum]["Days Since Last"])
	}
	catch (err) {
		dayVal = 0
	}
	// 'A' - don't increment days since duty
	// 'U' or 'D' - do increment the days since duty
  for (var i = 0; i < 40; i++) {
    if (da6_pers_list[rowNum]['Duty'][i] == 'A') { 
			//if (i == 39) {
				//da6_pers_list[rowNum]['Duty'][i] = 'A' + dayVal  
			//}
      continue
		} else if (isNaN(da6_pers_list[rowNum]['Duty'][i])) { 
			dayVal++
			//if (i == 39) {
				//da6_pers_list[rowNum]['Duty'][i] = da6_pers_list[rowNum]['Duty'][i] + dayVal  
			//}
    } else {
      da6_pers_list[rowNum]['Duty'][i] = dayVal++
    }
  }
}

// Go column by column and set the person with the highest days since the last duty
// to have duty for that day
function assignDuty (da6_list, column) {
  for(var col = column; col < 40; col++) {
    // assemble an array of the duty
		var peopleNeeded = parseInt($('#peoplePerDuty').val())
		if (isNaN(peopleNeeded)) {
			peopleNeeded = 1
		}
		for (var peopleToTask = 0; peopleToTask < peopleNeeded; peopleToTask++) {
			var soldierDuty = []
			for (var i = 0; i < da6_list.length; i++) {
				var dutyDays = parseInt(da6_list[i]['Duty'][col])
				if (isNaN(dutyDays)) { 
					dutyDays = 0 
				}
				soldierDuty.push(dutyDays)
			}
			// now assign a duty to the Soldier with the highest days
			var highestDays = Math.max(...soldierDuty)
			var soldierIndex = soldierDuty.indexOf(highestDays)
			// now reset the days to '0'

			// don't overwrite 'A' 'U' or 'D'
			// 'A' - don't increment days since duty
			// 'U' or 'D' - do increment the days since duty
			var dayValue = 0
			for (var j = col; j < 40; j++) {
				// check to see if the value is not a number
				if (da6_list[soldierIndex]['Duty'][j] == 'A') {
					continue
				} else if (isNaN(parseInt(da6_list[soldierIndex]['Duty'][j]))) {
					dayValue++
				} else {
					da6_list[soldierIndex]['Duty'][j] = dayValue++
				}
			}
		}
  }
}

// Take the DA6 data structure and generate an HTML table
function generateDa6Table (da6_pers_list) {
  var da6_table = document.getElementById('da6_table')

  // remove the current table
	while(da6_table.hasChildNodes()) {
		 da6_table.removeChild(da6_table.firstChild);
	}

	var natureOfDuty = $('#natureOfDuty').val()
	var organization = $('#organization').val()
	var fromDate = $('#fromDate').val()
	var toDate = $('#toDate').val()
	var fromDateVal = ''

	// if there is no date set, use the current day
	if (fromDate == '') {
		fromDateVal = DateTime.local()
	} else {
		fromDateVal = DateTime.fromISO(fromDate, { zone: 'utc' })
	}
  var toDateVal = fromDateVal.plus({ days: 39 })

  // the first three rows are the administrative data
	var firstRow = da6_table.insertRow(-1)
	var dutyRosterCell = firstRow.insertCell(-1)
	dutyRosterCell.innerHTML = 'DUTY ROSTER'
	dutyRosterCell.colSpan = 2
	var natureOfDutyCell = firstRow.insertCell(-1)
	natureOfDutyCell.innerHTML = 'NATURE OF DUTY<br />' + natureOfDuty
	natureOfDutyCell.colSpan = 12
	var orgCell = firstRow.insertCell(-1)
	orgCell.innerHTML = 'ORGANIZATION<br />' + organization
	orgCell.colSpan = 14
	var fromCell = firstRow.insertCell(-1)
	fromCell.innerHTML = 'FROM (Date)<br />' + fromDateVal.toFormat('dd MMM')
	fromCell.colSpan = 8
	var toCell = firstRow.insertCell(-1)
	toCell.innerHTML = 'TO (Date)<br />' + toDateVal.toFormat('dd MMM')
	toCell.colSpan = 7

  var secondRow = da6_table.insertRow(-1);
	var gradeCell = secondRow.insertCell(-1)
	gradeCell.innerHTML = 'GRADE'
	gradeCell.rowSpan = 2
	gradeCell.style = 'vertical-align: middle'
	var nameCell = secondRow.insertCell(-1)
	nameCell.innerHTML = 'NAME'
	nameCell.rowSpan = 2
	nameCell.style = 'vertical-align: middle'
  var date_cell = secondRow.insertCell(-1)
	date_cell.innerHTML = 'Month'

	// insert the second row for the date
	var dayCell 
	var monthNameCell
  var thirdRow = da6_table.insertRow(-1)
	dayCell = thirdRow.insertCell(-1)
	dayCell.innerHTML = 'Day'
	var curMonth
	var monthCellSpanWidth = 0
	var monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

	var currentDay = fromDateVal
	for (var h = 0; h < 40; h++) {
    dayCell = thirdRow.insertCell(-1)
		dayCell.innerHTML = currentDay.day
		if (h == 0) {
			monthNameCell = secondRow.insertCell(-1)
		  curMonth = currentDay.month
			monthNameCell.innerHTML = monthIndex[parseInt(curMonth) - 1]
		}
		if (curMonth != currentDay.month) {
		  curMonth = currentDay.month
			// set the monthNameCell span and then update the month
			monthNameCell.colSpan = monthCellSpanWidth
			monthNameCell = secondRow.insertCell(-1)
			monthCellSpanWidth = 0
			monthNameCell.innerHTML = monthIndex[parseInt(curMonth) - 1]
		}
		if (h == 39) {
			// this is the last time through, set the final month spanwidth
			monthCellSpanWidth++
			monthNameCell.colSpan = monthCellSpanWidth
		}
    currentDay = currentDay.plus({ days: 1 })
		monthCellSpanWidth++
	}

	// list soldiers, ranks, and duty assignments
	// add the number of rows for how many soldiers were imported
  for (var i = 0; i < da6_pers_list.length; i++) {
    var dutyRow = da6_table.insertRow(-1);
    var rankCell = dutyRow.insertCell(-1)
    var nameCell = dutyRow.insertCell(-1)
    var dutyCell

    rankCell.innerHTML = da6_pers_list[i].Rank
		nameCell.colSpan = 2
    nameCell.innerHTML = da6_pers_list[i].Person
    for (var j = 0; j < 40; j++) {
      dutyCell = dutyRow.insertCell(-1)
			if (da6_pers_list[i]['Duty'][j] == 0) {
      	dutyCell.innerHTML = '///'
      } else { 
				dutyCell.innerHTML = da6_pers_list[i]['Duty'][j]
			}
      dutyCell.onclick = function () {
        changeText(this)
      }
    }
  }
}

function changeText (tableCell) {
	// adjust the da6_pers_list
	var dayColumn = parseInt(tableCell.cellIndex) - 2
	var dayRow = parseInt(tableCell.parentElement.rowIndex) - 3

	// update the da6 data structure and then regenerate the table
  if(tableCell.innerHTML == 'A') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'D'
  }
  else if(tableCell.innerHTML == 'D') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'U'
  }
  else if(tableCell.innerHTML == 'U') {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 0
  }
  else {
    da6_pers_list[dayRow]['Duty'][dayColumn] = 'A'
  }

	for (var i = 0; i < da6_pers_list.length; i++) {
		adjustRowAvailability(da6_pers_list, i)
	}

  assignDuty(da6_pers_list, 0)

  generateDa6Table(da6_pers_list)

}

function exportFinalStatus (da6_pers_list, finalDay) {
	var exportDa6Json = []
	var person = []
  for (var i = 0; i < da6_pers_list.length; i++) {
		person = []
		person['Person'] = da6_pers_list[i].Person
		person['Rank'] = da6_pers_list[i].Rank
		person['Days Since Last'] = da6_pers_list[i]['Duty'][finalDay]
		// calculate the days that pass since the final end date
		// NEED TO WORK ON THIS PART - IMPROPER FORMAT
		//var endDate = DateTime.fromFormat(da6_pers_list[i]['End Date'], 'mm/DD/yyyy')
		//person['End Date'] = endDate.plus({ days: finalDay }).toFormat('mm/DD/yyyy')
		exportDa6Json.push(person)
	}
	return exportDa6Json
}

// (1) Soldiers who are absent or otherwise not available because of leave, pass, special duty, temporary duty, illness in
// line of duty, or any other authorized reason (not due to misconduct) will be indicated by the letter "A." When a new DA
// Form 6 is initiated that carries over a nonchargeable status from the previous DA Form 6, a superscript number (for example, A3) will be manually added to the abbreviation "A" to indicate the last number charged, as shown on the previous DA
// Form 6, before the Soldier entered upon the nonchargeable status. Entering such a number in the first column of a new DA
// Form 6 eliminates the necessity for referring to the previous DA Form 6 when the Soldier returns to a chargeable status.
// Note. Soldier on temporary duty travel that does not extend beyond regular duty hours will not qualify for an "A" for that
// day of temporary duty.

// (2) Soldiers eligible for detail who could not be selected because of previous detail or other duty will be indicated by
// the letter "D."

// (3) Soldiers not available because of being absent without leave, in arrest, in confinement, illness not in line of duty, or
// otherwise not available as a result of their own misconduct will be indicated by the letter "U."

</script>

</body>
</html>
