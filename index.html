<html>
<meta charset="UTF-8">
<head>
	<link rel="stylesheet" href="css/bootstrap.min.css">
</head>
<body>
<div class="form-group">
  <label  for="natureOfDuty">Nature of Duty</label>
  <input type="text" id="natureOfDuty" name="natureOfDuty"/>
</div>

<div class="form-group">
  <label  for="">Organization</label>
  <input type="text" id="organization" name="organization"/>
</div>

<div class="form-group">
  <label  for="">From (Date)</label>
  <input type="text" id="fromDate" name="fromDate"/>
</div>

<div class="form-group">
  <label  for="">To (Date)</label>
  <input type="text" id="toDate" name="toDate"/>
</div>

<div class="form-group">
  <label  for="">People per duty</label>
  <input type="number" id="peoplePerDuty" name="peoplePerDuty"/>
</div>

<div class="form-group">
  <label for="da6csv">Choose the DA6 CSV file to upload</label>
  <input type="file" id="da6csv" name="da6csv"/>
</div>
<div class="form-group">
	<button id="generateDa6" type="button" class="btn btn-primary btn-lg">Generate DA6 Roster</button>
</div>

<div class="form-group">
	<button id="generateMemo" type="button" class="btn btn-primary btn-lg">Generate Memo</button>
</div>

<hr>
<div id="da6" class="da6">
  <table id="da6_table" class="table table-bordered">
  </table>
</div>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script>

var DateTime = luxon.DateTime
var da6_pers_list = []

// Update the table when changing the number of people per task
$('#peoplePerDuty').change( function () {
	for (var i = 0; i < da6_pers_list.length; i++) {
		adjustRowAvailability(da6_pers_list, i)
	}
  assignDuty(da6_pers_list, 0)
  generateDa6Table(da6_pers_list)
})

// load the CSV to create the DA6
$('#da6csv').on('change', function(event) {
  var da6_file = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var da6group = $.csv.toObjects(e.target.result)
    // add the entries in the personnelGroup to the personnel chooser
    $.each(da6group, function (index, person) {
      // add all entries to the da6_pers_list
			// only add rows with people in them
			if (person.Person !== '') {
				da6_pers_list.push(person)
			}
    })
    // sort the list, first sort by rank, then sort by lastname
    da6_pers_list = sortByRankAndName(da6_pers_list)
  }
  reader.readAsText(da6_file)
})


// make a generate roster button
$('#generateDa6').on('click', function () {
		// get the date range, include this in the 'Duty' array of the da6_pers_list

	var fromDate = $('#fromDate').val()
	var toDate = $('#toDate').val()
	var fromDateVal = ''
	var toDateVal = ''

	// if there is no date set, use the current day
	// 2 options for setting the date
	// 1 - date set in the page
	// 2 - current date
	if (fromDate !== '') {
		fromDateVal = DateTime.fromISO(fromDate, { zone: 'utc' })
		toDateVal = DateTime.fromISO(toDate, { zone: 'utc' })
	// for now, the data structure for the csv file doesn't have the 'End Date'
	//} else if (da6_pers_list[0]['End Date'] !== undefined) {
		//fromDateVal = DateTime.fromFormat(da6_pers_list[0]['End Date'], 'MM/dd/yyyy').plus({ day: 1 })
	} else {
		fromDateVal = DateTime.local()
		toDateVal = fromDateVal.plus({ days: 39 })
	}

	var dateRange = generateDateRange(fromDateVal, toDateVal)
	for (var i = 0; i < da6_pers_list.length; i++) {
		populateDutyDays(da6_pers_list, i, dateRange)
	}
	assignDuty(da6_pers_list, 0)
	generateDa6Table(da6_pers_list)

})

$('#generateMemo').on('click', function () {
	alert('Function not implemented!\nPlease submit a pull request...\n\nhttps://www.github.com/stevewillson/da6_gen')

})

// sorts the input with values Rank and Name according to rank (higher rank first) then name (alphabetically)
function sortByRankAndName (sort_file) {
  // sort the pers list by rank and then name
  var ordering = {} // map for efficient lookup of sortIndex
  var sortOrder = ['COL', 'LTC', 'MAJ', 'CPT', '1LT', '2LT', 'CSM', 'SGM', '1SG', 'MSG', 'SFC', 'SSG', 'SGT', 'CPL', 'SPC', 'PFC', 'PV2', 'PVT']
  for (var i = 0; i < sortOrder.length; i++) {
    ordering[sortOrder[i]] = i
  }
  sort_file.sort( function(a, b) {
    return (ordering[a.Rank] - ordering[b.Rank]) || a.Person.localeCompare(b.Person)
  })
  return sort_file
}

// take a start and end date and return an array of dates from startDate to endDate (including both startDate and endDate)
function generateDateRange (startDate, endDate) {
	var dateArray = []
	// get the interval between the start and end date
  for (var curDate = startDate; endDate.diff(curDate, 'days').days >= 0; curDate = curDate.plus({ days: 1 })) {
		dateArray.push({ date: curDate.toISODate() })
	}
	return dateArray
}

function populateDutyDays (da6_pers_list, rowNum, dateRange) {
  // check if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day

	// for now, assume that duty will be every day from the last day until now
	var daysSinceLastDuty = da6_pers_list[rowNum]['daysSinceLastDuty']
	if (!isNaN(parseInt(daysSinceLastDuty))) {
		daysSinceLastDuty = parseInt(daysSinceLastDuty)
	} else if (parseInt(daysSinceLastDuty.substring(1)) > 0) {
		daysSinceLastDuty = parseInt(daysSinceLastDuty.substring(1))
	} else {
		daysSinceLastDuty = 0
	}
	da6_pers_list[rowNum]['Duty'] = []
  for (var i = 0; i < dateRange.length; i++) {
		// add 1 to the days since the last duty before it is stored
		daysSinceLastDuty++
		da6_pers_list[rowNum]['Duty'].push({ date: dateRange[i]['date'], daysSinceLastDuty: daysSinceLastDuty, dutyStatus: daysSinceLastDuty })
  }
}

function adjustRowAvailability (da6_pers_list, rowNum) {
  // see if a cell is not a number, if it is not a number ('A', 'D', or 'U')
  // then do not count that day
  try {
		var dayVal =  parseInt(da6_pers_list[rowNum]['daysSinceLastDuty'])
	}
	catch (err) {
		dayVal = 0
	}
	// 'A' - don't increment days since duty
	// 'U' or 'D' - do increment the days since duty
	for (var i = 0; i < da6_pers_list[0]['Duty'].length; i++) {
    if (da6_pers_list[rowNum]['Duty'][i]['dutyStatus'] == 'A') { 
      da6_pers_list[rowNum]['Duty'][i]['daysSinceLastDuty'] = dayVal
		} else if (isNaN(da6_pers_list[rowNum]['Duty'][i]['dutyStatus'])) { 
      da6_pers_list[rowNum]['Duty'][i]['daysSinceLastDuty'] = dayVal
			dayVal++
    } else {
      da6_pers_list[rowNum]['Duty'][i]['daysSinceLastDuty'] = dayVal
      da6_pers_list[rowNum]['Duty'][i]['dutyStatus'] = dayVal
      dayVal++
		}
  }
}

// Go column by column and set the person with the highest days since the last duty
// to have duty for that day
function assignDuty (da6_list, column) {

	// need to adjust this for an arbitrary long duty calendar
	for (var col = column; col < da6_list[0]['Duty'].length; col++) {
    // assemble an array of the duty
		var peopleNeeded = parseInt($('#peoplePerDuty').val())
		if (isNaN(peopleNeeded)) {
			peopleNeeded = 1
		}
		for (var peopleToTask = 0; peopleToTask < peopleNeeded; peopleToTask++) {
			var soldierDuty = []
			for (var i = 0; i < da6_list.length; i++) {
				var dutyDays = parseInt(da6_list[i]['Duty'][col]['dutyStatus'])
				if (isNaN(dutyDays)) { 
					dutyDays = 0 
				}
				soldierDuty.push(dutyDays)
			}
			// assign duty to the Soldier with the highest days
			var highestDays = Math.max(...soldierDuty)
			var soldierIndex = soldierDuty.indexOf(highestDays)
			// don't overwrite 'A' 'U' or 'D'
			// 'A' - do not increment days since duty
			// 'U' or 'D' - increment the days since duty
			var dayValue = 0
			for (var j = col; j < da6_list[0]['Duty'].length; j++) {
				// check to see if the value is not a number
				if (da6_list[soldierIndex]['Duty'][j]['dutyStatus'] == 'A') {
					// don't increment the date if the dutyStatus is 'A'
					da6_list[soldierIndex]['Duty'][j]['daysSinceLastDuty'] = dayValue
				} else if (isNaN(parseInt(da6_list[soldierIndex]['Duty'][j]['dutyStatus']))) {
					da6_list[soldierIndex]['Duty'][j]['daysSinceLastDuty'] = dayValue
					dayValue++
				} else {
					da6_list[soldierIndex]['Duty'][j]['daysSinceLastDuty'] = dayValue
					da6_list[soldierIndex]['Duty'][j]['dutyStatus'] = dayValue
					dayValue++
				}
			}
		}
  }
}

// take the DA6 data structure and generate an HTML table
function generateDa6Table (da6_pers_list) {
  var da6_table = document.getElementById('da6_table')

  // remove the current table
	while(da6_table.hasChildNodes()) {
		 da6_table.removeChild(da6_table.firstChild);
	}

	var natureOfDuty = $('#natureOfDuty').val()
	var organization = $('#organization').val()

  // the first three rows are the administrative data
	var firstRow = da6_table.insertRow(-1)
	var dutyRosterCell = firstRow.insertCell(-1)
	dutyRosterCell.innerHTML = 'DUTY ROSTER'
	dutyRosterCell.colSpan = 2
	var natureOfDutyCell = firstRow.insertCell(-1)
	natureOfDutyCell.innerHTML = 'NATURE OF DUTY<br />' + natureOfDuty
	natureOfDutyCell.colSpan = 12
	var orgCell = firstRow.insertCell(-1)
	orgCell.innerHTML = 'ORGANIZATION<br />' + organization
	orgCell.colSpan = 14
	var fromCell = firstRow.insertCell(-1)
	var fromDateVal = DateTime.fromISO(da6_pers_list[0]['Duty'][0]['date'])
	fromCell.innerHTML = 'FROM (Date)<br />' + fromDateVal.toFormat('dd MMM')
	fromCell.colSpan = 8
	var toCell = firstRow.insertCell(-1)
	var dutyArrayLength = da6_pers_list[0]['Duty'].length
	var toDateVal = DateTime.fromISO(da6_pers_list[0]['Duty'][dutyArrayLength-1]['date'])
	toCell.innerHTML = 'TO (Date)<br />' + toDateVal.toFormat('dd MMM')
	toCell.colSpan = 7

  var secondRow = da6_table.insertRow(-1);
	var gradeCell = secondRow.insertCell(-1)
	gradeCell.innerHTML = 'GRADE'
	gradeCell.rowSpan = 2
	gradeCell.style = 'vertical-align: middle'
	var nameCell = secondRow.insertCell(-1)
	nameCell.innerHTML = 'NAME'
	nameCell.rowSpan = 2
	nameCell.style = 'vertical-align: middle'
  var date_cell = secondRow.insertCell(-1)
	date_cell.innerHTML = 'Month'

	// insert the second row for the date
	var dayCell 
	var monthNameCell
  var thirdRow = da6_table.insertRow(-1)
	dayCell = thirdRow.insertCell(-1)
	dayCell.innerHTML = 'Day'
	var curMonth
	var monthCellSpanWidth = 0
	var monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

	// draw 40 columns, only populate values for required columns, leave the others blank
	for (var h = 0; h < da6_pers_list[0]['Duty'].length; h++) {
    dayCell = thirdRow.insertCell(-1)
		currentDay = DateTime.fromISO(da6_pers_list[0]['Duty'][h]['date'])
		dayCell.innerHTML = currentDay.day
		if (h == 0) {
			monthNameCell = secondRow.insertCell(-1)
		  curMonth = currentDay.month
			monthNameCell.innerHTML = monthIndex[parseInt(curMonth) - 1]
		}
		if (curMonth != currentDay.month) {
		  curMonth = currentDay.month
			// set the monthNameCell span and then update the month
			monthNameCell.colSpan = monthCellSpanWidth
			monthNameCell = secondRow.insertCell(-1)
			monthCellSpanWidth = 0
			monthNameCell.innerHTML = monthIndex[parseInt(curMonth) - 1]
		}
		if (h == da6_pers_list[0]['Duty'].length - 1) {
			// this is the last time through, set the final month spanwidth
			monthCellSpanWidth++
			monthNameCell.colSpan = monthCellSpanWidth
		}
    currentDay = currentDay.plus({ days: 1 })
		monthCellSpanWidth++
	}
	// continue this array to finish drawing the columns
	monthCellSpanWidth = 0
	monthNameCell = secondRow.insertCell(-1)
	for (h; h < 40; h++) {
    dayCell = thirdRow.insertCell(-1)
		monthCellSpanWidth++
		monthNameCell.colSpan = monthCellSpanWidth
	}

	// list soldiers, ranks, and duty assignments
	// add the number of rows for how many soldiers were imported
  for (var i = 0; i < da6_pers_list.length; i++) {
    var dutyRow = da6_table.insertRow(-1);
    var rankCell = dutyRow.insertCell(-1)
    var nameCell = dutyRow.insertCell(-1)
    var dutyCell

    rankCell.innerHTML = da6_pers_list[i].Rank
		nameCell.colSpan = 2
    nameCell.innerHTML = da6_pers_list[i].Person
    for (var j = 0; j < da6_pers_list[i]['Duty'].length; j++) {
      dutyCell = dutyRow.insertCell(-1)
			if (da6_pers_list[i]['Duty'][j]['dutyStatus'] == 0) {
      	dutyCell.innerHTML = '///'
      } else { 
				dutyCell.innerHTML = da6_pers_list[i]['Duty'][j]['dutyStatus']
			}
      dutyCell.onclick = function () {
        changeText(this)
      }
    }
		// populate the rest of the row with empty cells
    for (j; j < 40; j++) {
      dutyCell = dutyRow.insertCell(-1)
		}
  }
}

function changeText (tableCell) {
	// adjust the da6_pers_list
	var dayColumn = parseInt(tableCell.cellIndex) - 2
	var dayRow = parseInt(tableCell.parentElement.rowIndex) - 3

	// update the da6 data structure and then regenerate the table
  if(tableCell.innerHTML == 'A') {
    da6_pers_list[dayRow]['Duty'][dayColumn]['dutyStatus'] = 'D'
  }
  else if(tableCell.innerHTML == 'D') {
    da6_pers_list[dayRow]['Duty'][dayColumn]['dutyStatus'] = 'U'
  }
  else if(tableCell.innerHTML == 'U') {
    da6_pers_list[dayRow]['Duty'][dayColumn]['dutyStatus'] = da6_pers_list[dayRow]['Duty'][dayColumn]['daysSinceLastDuty']
  }
  else {
    da6_pers_list[dayRow]['Duty'][dayColumn]['dutyStatus'] = 'A'
  }
	for (var i = 0; i < da6_pers_list.length; i++) {
		adjustRowAvailability(da6_pers_list, i)
	}
  assignDuty(da6_pers_list, 0)
  generateDa6Table(da6_pers_list)
}

// output the Soldier name, rank and final status of the duty
function exportFinalStatus (da6_pers_list) {
	var exportDa6Json = []
	var person = []
  for (var i = 0; i < da6_pers_list.length; i++) {
		person = []
		person['Person'] = da6_pers_list[i].Person
		person['Rank'] = da6_pers_list[i].Rank
		var dutyArrayLength = da6_pers_list[i]['Duty'].length
		person['daysSinceLastDuty'] = da6_pers_list[i]['Duty'][dutyArrayLength-1]['daysSinceLastDuty']
		exportDa6Json.push(person)
	}
	return exportDa6Json
}

</script>
</body>
</html>
